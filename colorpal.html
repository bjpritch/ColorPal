<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>ColorPal!</title>
<meta name="Generator" content="Vim/7.3">
<meta name="plugin-version" content="vim7.3_v10">
<meta name="syntax" content="html">
<meta name="settings" content="use_css,pre_wrap,expand_tabs">
<link href="http://fonts.googleapis.com/css?family=Titan+One" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Ovo'       rel='stylesheet' type='text/css'>
<link href="css/960_24_col.css" rel="stylesheet" type="text/css">

<script type="text/javascript" src="includes/jquery-1.7.1.min.js"></script>
<script type="text/javascript" src="includes/jquery.tmpl.js"></script>
<script type="text/javascript" src="includes/knockout-2.0.0.debug.js"></script>
<script type="text/javascript" src="includes/farbtastic/farbtastic.js"></script>
<link rel="stylesheet" href="includes/farbtastic/farbtastic.css" type="text/css" />

<style type="text/css">
<!--
pre { white-space: pre-wrap; font-family: monospace; color: #d7d7d7; }
body { font-family: Verdana, sans-serif; cursive; color: #fff; background-color: #000; }
h1 {
    font-family : 'Titan One';
    font-weight : 400;
}
a { color: #ddd; }
a:visited { color: #999; }
p.instructions {
    font-family: Ovo;
    font-size: 1.3em;
}
h1 {
    font-size   : 3em;
}
p.credits {
}
img.logo {
    float: left;
}

[draggable] {
    -webkit-user-selectable: none;
     -khtml-user-selectable: none;
       -moz-user-selectable: none;
         -o-user-selectable: none;
            user-selectable: none;
}

.container {
    margin-top: 20px;
}

#cp-canvas { 

    outline: 6px solid #999;
    border: 1px solid #000;

    margin: 24px;

    -webkit-transition: all 0.33s ease-in; /* Safari and Chrome */
       -moz-transition: all 0.33s ease-in; /* Firefox 4 */
         -o-transition: all 0.33s ease-in; /* Opera */
            transition: all 0.33s ease-in;
}

#cp-input-image {
    display: none;
}

/****************************************
 * Container for all the color swatches *
 ****************************************/

.cp-swatches {
    line-height : 0;
    height: 66px;
    position    : relative;

    -webkit-transition : all ease 0.13s;
       -moz-transition : all ease 0.13s;
         -o-transition : all ease 0.13s;
            transition : all ease 0.13s;

}

/*********************************
 * Styles for the swatch squares *
 *********************************/

.cp-swatch {
    display  : block;
    float    : left;
    position : relative;
    width    : 80px;
    height   : 80px;

    -webkit-border-radius: 2px;
       -moz-border-radius: 2px;
         -o-border-radius: 2px;
            border-radius: 2px;

    -webkit-transition : all ease 0.33s;
       -moz-transition : all ease 0.33s;
         -o-transition : all ease 0.33s;
            transition : all ease 0.33s;
}

.cp-swatch-selected { 
    top    : 8px;
}

/***********************
 * Color picker styles *
 ***********************/

#cp-picker {
    position: absolute;
    right: 10px;
    -webkit-transition : all ease 0.33s;
       -moz-transition : all ease 0.33s;
         -o-transition : all ease 0.33s;
            transition : all ease 0.33s;
}
.cp-picker-active {
    opacity: 1.0;
    visibility: visible;
}
.cp-picker-inactive {
    opacity: 0;
    visibility: hidden;
}
-->
</style>

<script type="text/javascript" src="median-cut.js/median-cut.js"> </script>
<script type="text/javascript" src="imagedata_to_rgb.js"> </script>
<script type="text/javascript">

var farb, pick, selected, CP_ViewModel;
$(document).ready(function() {

    CP_ViewModel = {

        colors : ko.observableArray( [
            new CP_Color("#000"), new CP_Color("#000"),
            new CP_Color("#000"), new CP_Color("#000"),
            new CP_Color("#000"), new CP_Color("#000"),
            new CP_Color("#000"), new CP_Color("#000"),
        ]),

    };

    ko.applyBindings( CP_ViewModel );


    farb = $.farbtastic('#cp-picker');
    farb.linkTo(function( hex ) {
        if( selected ) {
            var swatch_id = $(selected).attr('id').slice(-1);
            CP_ViewModel.colors()[ swatch_id ].hex( hex );
        }
    });
    pick = $('#cp-picker');
    selected;
    $('.cp-swatch')
        .click(function() {
            if (selected) {
                $(selected).removeClass('cp-swatch-selected');
            }
            if ( selected == this ) {
                pick.removeClass('cp-picker-active');
                pick.addClass('cp-picker-inactive');
                $(this).removeClass('cp-swatch-selected');
                selected = false;
            } else {

                var swatch_id = $(this).attr('id').slice(-1);
                farb.setColor( CP_ViewModel.colors()[ swatch_id ].hex() );

                pick.removeClass('cp-picker-inactive');
                pick.addClass('cp-picker-active');
                $(selected = this).addClass('cp-swatch-selected');
            }
        });

    function CP_Color( hex ) {
        return {
            hex: ko.observable(hex)
        };
    }
});

var ctx,
    ctx_small,
    canvas,
    canvas_small,
    mc,
    img_width  = 0,
    img_height = 0,
    canvas_width  = 400,
    canvas_height = 400,
    canvas_small_height = 128,
    canvas_small_width = 128;

function handle_file_select( evt ) {

    if( evt.stopPropagation ) evt.stopPropagation();
    if( evt.preventDefault  ) evt.preventDefault();

    var files = evt.dataTransfer.files; // FileList object

    // Loop through the FileList and render image files as thumbnails.
    for ( var i = 0, f; f = files[i]; i++ ) {

        // Only process image files.
        if (!f.type.match('image.*')) {
            continue;
        }

        var reader       = new FileReader();
        var img          = document.createElement("img"); // display-size image
        var img_small    = document.createElement("img"); // smaller image for faster median cut

        img.onload = function() {

            var img_ratio     = img.width / img.height;
            var canvas_height = 400;
            var canvas_width  = 400;

            /*
            if( img_ratio > 1 ) { 
                // width > height
                if( img.width > canvas_width ) {
                    canvas_height = img.height
                }
            } else {
                // height > width
            }
            */
            canvas_width  = ( img.width  > canvas_width  ) ? ( img_ratio > 1 ) ? canvas_width  : canvas_width*img_ratio  : img.width;
            canvas_height = ( img.height > canvas_height ) ? ( img_ratio < 1 ) ? canvas_height : canvas_height/img_ratio : img.height;
            // Resize the canvas to the image size
            canvas.width             = canvas_width;
            canvas.height            = canvas_height;

            // Resize the canvas with CSS to trigger CSS3 transitions
            canvas.style.width       = canvas_width + "px";
            canvas.style.height      = canvas_height + "px";

            // Draw the downsized image inside the canvas
            ctx_small.drawImage( img, 0, 0, canvas_small_width, canvas_small_height );

            var data = ctx_small.getImageData( 0, 0, canvas_small_width, canvas_small_height );
            var rgbdata = imagedata_to_rgb( data );
            console.time("mc");
            mc = MedianCut();
            mc.init( rgbdata );
            var palette = mc.get_fixed_size_palette( 8 );
            console.timeEnd("mc");

            // clear any previous swatches

            for( var ic = palette.length - 1; ic >= 0; ic-- ) {
                var color = palette[ic];
                var hex = farb.pack( [ color[0]/255, color[1]/255, color[2]/255 ] );
                CP_ViewModel.colors()[ic].hex(hex);
                //var sp = create_swatch( ic, color );
                //swatches.appendChild( sp );
            }

            // Draw the display image
            ctx.drawImage( img, 0, 0, canvas_width, canvas_height );

        };

        // Read in the image file as a data URL.
        reader.readAsDataURL(f);

        reader.onload = function(e) {

            // Assign the image's src to the filesystem image's data URL [http://en.wikipedia.org/wiki/Data_URI_scheme]
            img.src = e.target.result; 

        };
    }
}


// Drag and drop event handlers
function file_drag_start( e ) {

    if( e.stopPropagation ) {
        e.stopPropagation()
    }

    return false;
}

function file_drag_enter( e ) {
}

function file_drag_over( e ) {
    e.stopPropagation();
    e.preventDefault();
    e.dataTransfer.dropEffect="copy";
    canvas.style.outline = "6px solid #fff";
}

function file_drag_leave( e ) {
    e.stopPropagation();
    e.preventDefault();
    e.dataTransfer.dropEffect="copy";
    canvas.style.outline = "6px solid #999";
}

function file_drop( e ) {

    console.log("file drop");
    
    e.stopPropagation();
    e.preventDefault();

    var files = e.dataTransfer.files;
    for( var i = 0, f; f = files[i]; i++ ) {
        console.log( f );
    }

}

function file_drag_end  ( e ) {
}





window.onload = function() {
    document.getElementById("cp-input-image").onchange = handle_file_select;

    canvas              = document.getElementById("cp-canvas");

    canvas_small        = document.createElement("canvas");
    canvas_small.width  = canvas_small_width;
    canvas_small.height = canvas_small_height;

    ctx                 = canvas.getContext("2d");
    ctx_small           = canvas_small.getContext("2d");

    // Set up drag handles
    var image_drop_zone = document.getElementById("cp-canvas");
    image_drop_zone.addEventListener( "dragstart", file_drag_start   , false );
    image_drop_zone.addEventListener( "dragenter", file_drag_enter   , false );
    image_drop_zone.addEventListener( "dragover" , file_drag_over    , false );
    image_drop_zone.addEventListener( "dragleave", file_drag_leave   , false );
    image_drop_zone.addEventListener( "drop"     , handle_file_select, false );
    image_drop_zone.addEventListener( "dragend"  , file_drag_end     , false );

    /* TODO: enable file input selection of images (esp. for mobile)
    var file_input = document.getElementById("cp-input-image");
    file_input.addEventListener( "change", handle_file_select, false );
    */


};



</script>

</head>
<body>

<div class="container_24 container">

    <img class="grid_3" src="images/logo.png" alt="ColorPal logo" />
    <h1 class="grid_11">ColorPal!</h1>
    <p class="grid_10 instructions">
        Want to generate a color palette from an image?  
        <br />
        Drag your image into the box below. :)
    </p>

    <div class="clear"></div>

    <input type="file" id="cp-input-image"></input>

    <div id="list"></div>


    <div data-bind="template: { name: 'CP_PaletteTemplate' }"></div>

    <script id="CP_PaletteTemplate" type="text/html">
        {{each(index,hex) colors}}
        <div 
            class="cp-swatch" 
            id="cp-swatch-${index}" 
            data-bind="style: { backgroundColor: hex() }"> </div>
        <input 
            type="hidden" 
            data-bind="value: hex"
            size="7" />
        {{/each}}
    </script>

    <div class="clear"></div>

    <canvas id="cp-canvas" class="grid_16"></canvas>

    <div id="cp-picker" class="cp-picker-inactive"></div>

    <p class="credits grid_24"><a href="http://mwcz.org">Author</a>  <a href="https://github.com/mwcz/ColorPal">Code</a>  <a href="https://twitter.com/mwcz">Twitter</a></p>

</div> <!-- /.container_24 -->

</body>
</html>

